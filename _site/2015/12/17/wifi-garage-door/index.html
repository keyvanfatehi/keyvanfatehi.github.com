
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>DIY WiFi Garage door opener and status checker</title>
    
    <meta name="author" content="Keyvan Fatehi">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Keyvan's Blog</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/reference/index.html">Reference</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tools/index.html">Tools</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>DIY WiFi Garage door opener and status checker </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>17 December 2015</span>
    </div>
    <div class="content">
      <iframe width="640" height="350" src="http://www.youtube.com/embed/4XBNwHmx-4Q" frameborder="0" allowfullscreen></iframe>

<p><em>I borrowed my brother&#39;s iPhone in order to capture the video.</em></p>

<h1>Summary</h1>

<p>My dad and I made a wifi garage door opener and status checker.</p>

<p>We did this project crazy-fast and without any hang-ups, which was interesting to me because it showed how far along the tools have come.</p>

<h2>Hardware</h2>

<ul>
<li>Original Raspberry Pi</li>
<li>1x Opto-isolator</li>
<li>1x reed switch</li>
</ul>

<h2>Embedded Software:</h2>

<ul>
<li>OS: Nerves (Linux boot to Erlang)</li>
<li>App: Custom Elixir app <a href="https://github.com/kfatehi/codelock">source</a></li>
</ul>

<h2>Mobile Software:</h2>

<ul>
<li>App: Custom Ionic app <a href="https://github.com/kfatehi/AfternoonCommander">source</a></li>
</ul>

<h1>Full Story</h1>

<p>Our garage door opener has a physical panel just outside where one can enter a 4 digit pin and open the garage.</p>

<p>After some faily recent rain storms, the panel has been malfunctioning and fails to work 95% of the time. It&#39;s not a battery issue.</p>

<p>It was expensive to replace that from the manufacturer, and we didn&#39;t want the same faulty product!</p>

<p>We want to know if the garage door is open or closed and be able to open or close it remotely.</p>

<h2>Solution</h2>

<p>This would take two GPIO pins.</p>

<ol>
<li><p>read logic level 1 or 0 based on the garage door being open or closed. a <a href="https://en.wikipedia.org/wiki/Reed_switch">reed switch</a> affixed to the door&#39;s frame, adjecent to a strong magnet on the door, will do the trick.</p></li>
<li><p>write logic level 1 to a circuit that simulates a button press on the garage door manual switch, located inside the garage. We used an <a href="https://en.wikipedia.org/wiki/Opto-isolator">opto-isolator</a> for this.</p></li>
</ol>

<h2>Build-out</h2>

<h3>Embedded</h3>

<p>I used <a href="http://nerves-project.org">Nerves</a> on an old Raspberry Pi.</p>

<p><strong>Nerves makes it possible to create minimal ARM firmware that boots directly into the Erlang virtual machine (BEAM).</strong></p>

<p>Essentially it helps you compile a barebones linux kernel with the init system replaced.</p>

<p>I chose Nerves because I like <a href="http://elixir-lang.org">Elixir</a> and the emphasis placed on making fault-tolerant systems right from the start. I think it&#39;s quite apt for the embedded space.</p>

<p>After making Nerves development <a href="https://github.com/nerves-project/homebrew-nerves">easier on Mac</a>, I started the project.</p>

<p>Controlling GPIO pins was easy to do thanks to <a href="https://github.com/fhunleth/elixir_ale">Elixir ALE</a>.</p>

<p>The core concept is to listen on HTTP and allow read/write on any GPIO pin:</p>
<div class="highlight"><pre><code class="elixir language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Codelock</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
<span class="k">  </span><span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Logger</span>
  <span class="n">plug</span> <span class="no">Corsica</span><span class="p">,</span> <span class="ss">origins:</span> <span class="s2">&quot;*&quot;</span>
  <span class="n">plug</span> <span class="ss">:match</span>
  <span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Parsers</span><span class="p">,</span> <span class="ss">parsers:</span> <span class="p">[</span><span class="ss">:urlencoded</span><span class="p">,</span> <span class="ss">:json</span><span class="p">],</span> <span class="ss">json_decoder:</span> <span class="no">Poison</span>
  <span class="n">plug</span> <span class="ss">:dispatch</span>

  <span class="k">def</span> <span class="n">start_link</span> <span class="k">do</span>
<span class="k">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Cowboy</span><span class="o">.</span><span class="n">http</span> <span class="no">Codelock</span><span class="o">.</span><span class="no">Router</span><span class="p">,</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s2">&quot;/digital_write/:gpio_out/:value&quot;</span> <span class="k">do</span>
<span class="k">    </span><span class="n">gpio_out</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">to_integer</span> <span class="o">|&gt;</span> <span class="n">digital_write</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">to_integer</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="s2">&quot;{}&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">post</span> <span class="s2">&quot;/digital_read/:gpio_in&quot;</span> <span class="k">do</span>
<span class="k">    </span><span class="n">value</span> <span class="o">=</span> <span class="n">gpio_in</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">to_integer</span> <span class="o">|&gt;</span> <span class="n">digital_read</span>
    <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="no">Poison</span><span class="o">.</span><span class="n">encode!</span><span class="p">(</span><span class="err">%</span><span class="p">{</span> <span class="ss">value:</span> <span class="n">value</span> <span class="p">}))</span>
  <span class="k">end</span>

  <span class="n">match</span> <span class="n">_</span> <span class="k">do</span>
<span class="k">    </span><span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">404</span><span class="p">,</span> <span class="s2">&quot;Not found&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">digital_write</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">Gpio</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="ss">:output</span><span class="p">)</span>
    <span class="no">Gpio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Wrote </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to pin </span><span class="si">#{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="no">Process</span><span class="o">.</span><span class="k">exit</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:normal</span><span class="p">)</span>
    <span class="n">value</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">digital_read</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">Gpio</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="ss">:input</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="no">Gpio</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Read </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2"> from pin </span><span class="si">#{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="no">Process</span><span class="o">.</span><span class="k">exit</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:normal</span><span class="p">)</span>
    <span class="n">value</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3>Circuit</h3>

<p>Credit goes 100% to my dad for all the circuit design and prep downstream of the GPIO pins. If you&#39;d like to replicate this look at the reference schematics for an appropriate voltage reed switch and opto-isolator.</p>

<p>All I had to do was put the board together with the Raspberry Pi:</p>

<p><img src="/assets/images/garage-door/1.png" alt="naked boards">
<img src="/assets/images/garage-door/2.png" alt="pi closeup"></p>

<h3>Mobile App</h3>

<p>Prior experience indicated that <a href="http://ionicframework.com/">Ionic</a> would make the mobile app development portion trivial.</p>

<p>The core concept for the mobile UI here was to list one or more &quot;things&quot; that have state and can be toggled:</p>
<div class="highlight"><pre><code class="html language-html" data-lang="html"><span class="nt">&lt;ion</span><span class="na">-view</span> <span class="na">view-title=</span><span class="s">&quot;Dashboard&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ion</span><span class="na">-content</span> <span class="na">class=</span><span class="s">&quot;padding&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;list card&quot;</span> <span class="na">ng-repeat=</span><span class="s">&quot;thing in things&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;item item-divider&quot;</span> <span class="na">ng-init=</span><span class="s">&quot;thing.init()&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;item item-body&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          State: 
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;button button-full button-positive&quot;</span> <span class="na">ng-click=</span><span class="s">&quot;thing.toggle()&quot;</span><span class="nt">&gt;</span>
          Toggle
        <span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="err">&lt;</span>/ion-content&gt;
<span class="err">&lt;</span>/ion-view&gt;
</code></pre></div>
<p>The core concept for the controller was to provide the list of &quot;things&quot; that know how to fetch state and be toggled:</p>
<div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="nx">$scope</span><span class="p">.</span><span class="nx">things</span> <span class="o">=</span> <span class="p">[{</span>
  <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;Garage Door&quot;</span><span class="p">,</span>
  <span class="nx">state</span><span class="o">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
  <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">fetchState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;http://garage:4000/digital_read/4&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">httpConfig</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Open&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s2">&quot;Closed&quot;</span><span class="p">;</span>
      <span class="p">})</span>
    <span class="nx">fetchState</span><span class="p">();</span>
    <span class="nx">setInterval</span><span class="p">(</span><span class="nx">fetchState</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;http://garage:4000/digital_write/18/1&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">httpConfig</span><span class="p">).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;http://garage:4000/digital_write/18/0&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">httpConfig</span><span class="p">)</span>
      <span class="p">},</span> <span class="mi">800</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}];</span>
</code></pre></div>
<p>This code could definitely use improvement (and reveals other problems), but this resulted in a decent app:</p>

<p><img src="/assets/images/garage-door/5.png" alt="ionic app"></p>

<h2>Installation</h2>

<p>After soldering the wires from our opto-isolator into the manual switch, we&#39;ve got this:</p>

<p><img src="/assets/images/garage-door/3.png" alt="manual switch"></p>

<p>The last step was hooking up the reed switch to the door. You can see the reed switch in the left of the pic below:</p>

<p><img src="/assets/images/garage-door/4.png" alt="reed switch"></p>

<p>You can see the whole thing in action in the video at the top of this post.</p>

    </div>

    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#diy-ref">diy <span>1</span></a></li>
     
    	<li><a href="/tags.html#nerves-ref">nerves <span>1</span></a></li>
     
    	<li><a href="/tags.html#elixir-ref">elixir <span>1</span></a></li>
     
    	<li><a href="/tags.html#erlang-ref">erlang <span>1</span></a></li>
     
    	<li><a href="/tags.html#embedded-ref">embedded <span>1</span></a></li>
     
    	<li><a href="/tags.html#raspberry pi-ref">raspberry pi <span>3</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/blog/2015/07/20/setup-go-compiler-on-arm-and-compile-buildkite-agent" title="Setting up Go compiler on ARMv7 to run the Buildkite Agent">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next disabled"><a>Next &rarr;</a>
      
      </ul>
    </div>
    
  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2015 Keyvan Fatehi
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

<link rel="stylesheet" href="/assets/css/pygments.css">