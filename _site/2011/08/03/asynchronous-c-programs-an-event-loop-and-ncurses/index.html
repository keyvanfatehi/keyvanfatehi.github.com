
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Asynchronous C programs: an event loop and Ncurses</title>
    
    <meta name="author" content="Keyvan Fatehi">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">blog of keyvan</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>Asynchronous C programs: an event loop and Ncurses </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>03 August 2011</span>
    </div>
    <div class="content">
      <p>You may wonder how you can use ncurses in an asynchronous fashion in your program. Doesn&#8217;t ncurses block on getch(), thus forcing your program out of any of your asnychronous hopes and dreams?</p>
<p>Well, no, you don&#8217;t HAVE to use getch() to get characters, and as long as you do not call any of these blocking functions, and find another way to get input in an asynchronous fashion, you can very well use the keyboard event of a character to drive your ncurses gui.</p>
<p>You can also have events happening on other file descriptors at the same time. This is the nature of asynchronous programming&#8212;things are happening at the same time, all functions are returning as soon as possible, and nothing is waiting for anything else.</p>
<p>Your program spends most of its time in the &#8220;event loop&#8221; where it waits for &#8220;something to happen&#8221; (e.g. data just came in on the standard input, or data just came in on a TCP socket), after which it will fire off the &#8220;callback&#8221; in which you&#8217;ve described what work should be done in the event of such anÂ occurrence.</p>
<p>The following is what the code for this looks like if you were to use poll(). Keep in mind there are other functions, such as select(), that do the same thing, but are used in a slightly different way.</p>
<pre>#include &lt;sys/poll.h&gt; // poll() is of course made available by this header file
#include &lt;unistd.h&gt;      // STDIN_FILENO is defined in here, and close() for sockets
#include &lt;ncurses.h&gt;

int main() {
  struct pollfd ufds[2]; // Data structure we later pass to poll() for monitoring
  int sockfd;            // File descriptor for the TCP socket
  int STDIN_FILENO       // this is just 0

  initscr();             // Start ncurses

  connect(sockfd, ..., ...);   // Connecting a unix socket has a few more steps
                               // see links at the end for more info
  pUfds[0].fd = sockfd;        // Pack our connected TCP socket file descriptor in.
  pUfds[0].events = POLLIN;    // we only care if the socket is ready for read (Has data)
  pUfds[1].fd = STDIN_FILENO;  // Pack our standard input file descriptor in.
  pUfds[1].events = POLLIN;    // Again, we only care when there's data for reading.

  do {
    switch(poll(ufds, 2, -1)) {
      case -1:{ refresh(); break;} // resizing the terminal causes poll() to return -1 (error)
      default:{                    // So I simply refresh() the ncurses view when that happens
        if (ufds[0].revents &amp; POLLIN)  
          onSocketData();              // my callback for socket activity 
        if (ufds[1].revents &amp; POLLIN)
          onKeyData();                 // my callback for keyboard activity
      }
    }
  } while(Running); // this variable serves as a killswitch

  endwin(); // End ncurses
  close(sockfd);
  return 0;
}
</pre>
<p>The above is chopped and sliced out of a program I&#8217;ve been working on:</p>
<p><a title="Network Vim" target="_blank" href="http://github.com/keyvanfatehi/nim%20%20"><a href="http://github.com/keyvanfatehi/nim">http://github.com/keyvanfatehi/nim</a></a></p>
<p>If you are interested in Unix socket and network programming, I highly recommend this resource:</p>
<p><a target="_blank" href="http://beej.us/guide/bgnet/"><a href="http://beej.us/guide/bgnet/">http://beej.us/guide/bgnet/</a></a></p>

    </div>

    

    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2011/07/18/imagemagick-and-its-delegate-libraries" title="ImageMagick and its delegate libraries">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2011/08/08/unnamed" title="unnamed">Next &rarr;</a></li>
      
      </ul>
    </div>
    
  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2014 Keyvan Fatehi
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

<link rel="stylesheet" href="/assets/css/pygments.css">