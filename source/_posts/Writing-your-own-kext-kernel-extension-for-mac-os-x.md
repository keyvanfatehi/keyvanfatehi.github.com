---
date: '2011-06-12'
title: Writing your own kext kernel extension for mac os x
tags:
- xcode
- osx
---
<p>Direct copypasta of <a href="http://unixjunkie.blogspot.com/2006/12/kernel-extension-by-hand.html"><a href="http://unixjunkie.blogspot.com/2006/12/kernel-extension-by-hand.html">http://unixjunkie.blogspot.com/2006/12/kernel-extension-by-hand.html</a></a></p>
<p><span> </span></p>
<p>I generally like using Xcode. It typically does the job, and usually even makes the job easier. It shields the user from having to worry about mundane details that are all too common when building software. However, for the same reason it can increase a developer&#8217;s productivity, it can also make it more difficult to understand what&#8217;s actually going on. For example, Xcode has a template to create a Generic Kernel Extension. The template compiles <em>with no modifications</em>. The resulting kernel extension (KEXT) can then be loaded and unloaded without having to write one line of code. This is super cool, but it also hides some of the details of what a KEXT really is. So, today we&#8217;ll write a &#8220;Hello, World&#8221; KEXT from scratch without the help of Xcode<br/><br/><em>(note the issues above do not apply to Xcode alone, rather they apply to almost all IDEs)</em><br/><br/>Well, let&#8217;s just jump right in. Basically, a KEXT is a bundle on Mac OS X (it&#8217;s also a &#8220;package&#8221;), which means it is a directory structure with some predefined form and an Info.plist file. Our sample KEXT will be named &#8220;MyKext.kext&#8221;, and it will be in a directory structure that looks like this:</p>
<pre>$ <strong>find MyKext.kext</strong><br/>MyKext.kext<br/>MyKext.kext/Contents<br/>MyKext.kext/Contents/Info.plist<br/>MyKext.kext/Contents/MacOS<br/>MyKext.kext/Contents/MacOS/MyKext<br/></pre>
<p><br/><br/>To start off, we need to make the basic directory structure.</p>
<pre>$ <strong>cd</strong><br/>$ <strong>mkdir -p MyKext.kext/Contents/MacOS</strong><br/>$ <strong>cd MyKext.kext/Contents/MacOS</strong></pre>
<p><br/><br/>Now we can start writing our code. Our code will contain two main routines: <code>MyKextStart()</code> and <code>MyKextStop()</code>, which are called when the KEXT is loaded and unloaded respectively. It will also contain some required bookkeeping code that&#8217;s needed in order to make our compiled binary proper. Our start and stop routines look like:</p>
<pre>// File: mykext.c<br/>#include &lt;libkern/libkern.h&gt;<br/>#include &lt;mach/mach_types.h&gt;<br/><br/>kern_return_t MyKextStart(kmod_info_t *ki, void *d) {<br/>  printf("Hello, World!\n");<br/>  return KERN_SUCCESS;<br/>}<br/><br/>kern_return_t MyKextStop(kmod_info_t *ki, void *d) {<br/>  printf("Goodbye, World!\n");<br/>  return KERN_SUCCESS;<br/>}<br/><br/>... more to come in a minute<br/></pre>
<p><br/><br/>After these two methods (in the same <code>mykext.c</code> file) we need to put the required bookkeeping stuff.</p>
<pre>extern kern_return_t _start(kmod_info_t *ki, void *data);<br/>extern kern_return_t _stop(kmod_info_t *ki, void *data);<br/><br/>KMOD_EXPLICIT_DECL(net.unixjunkie.kext.MyKext, "1.0.0d1", _start, _stop)<br/>__private_extern__ kmod_start_func_t *_realmain = MyKextStart;<br/>__private_extern__ kmod_stop_func_t *_antimain = MyKextStop;<br/>__private_extern__ int _kext_apple_cc = __APPLE_CC__;</pre>
<p><br/><br/>This stuff basically declares some needed structures, and it also sets up our routines (<code>MyKextStart()</code> and<code>MyKextStop()</code>) so that they&#8217;re called on load and unload, by assigning them to the <code>_realmain</code> and <code>_antimain</code>symbols respectively.<br/><br/>OK, now comes the tricky part: the compile. KEXTs are compiled statically, they can only use certain headers that are available in the kernel, and they can&#8217;t link with the standard C library. These requirements basically translate into a <code>gcc</code> command like the following:<br/><br/></p>
<pre>$ <strong>gcc -static <em>mykext.c</em> -o <em>MyKext</em> -fno-builtin -nostdlib -lkmod -r -mlong-branch -I/System/Library/Frameworks/Kernel.framework/Headers -Wall</strong></pre>
<p><br/><br/>If the planets are properly aligned, you won&#8217;t get any errors or warnings, and you&#8217;ll end up with a Mach-O object file in the current directory named <code>MyKext</code>. This is your actual compiled KEXT. (At this point, it&#8217;s fun to inspect this file using <code>otool</code>. For example, <code>otool -hV MyKext</code>, and <code>otool -l MyKext</code>. Read the man page for <code>otool(1)</code> for more details here.)<br/><br/>Now, the last thing we need to do (before we actually load this thing up) is to give our KEXT an Info.plist. The easiest way to do this is to copy another KEXT&#8217;s Info.plist file, and change the names of a few things. For this example, I&#8217;m going to copy <code>/System/Library/Extensions/webdav_fs.kext/Contents/Info.plist</code>.</p>
<pre>$ <strong>cd ..</strong><br/>$ <strong>pwd</strong><br/>/Users/jgm/MyKext.kext/Contents<br/>$ <strong>cp /System/Library/Extensions/webdav_fs.kext/Contents/Info.plist .</strong></pre>
<p><br/><br/>Now, you&#8217;ll need to edit the file and change the value of the &#8220;CFBundleExecutable&#8221; key to <strong>MyKext</strong>, and the value of &#8220;CFBundleIdentifier&#8221; to <strong>net.unixjunkie.kext.MyKext</strong> (or whatever you set that value to in your <code>mykext.c</code> file).<br/><br/>Okay, it&#8217;s show time. To load any KEXT, all files in the KEXT must be owned by <code>root</code> and be in group <code>wheel</code>. The files must also have certain permissions in order to load. Here&#8217;s the steps to load the KEXT.<br/><br/></p>
<pre>$ <strong>cd /tmp</strong><br/>$ <strong>sudo -s</strong><br/># <strong>cp -rp ~/MyKext.kext .</strong><br/># <strong>chown -R root:wheel MyKext.kext</strong><br/># <strong>chmod -R 0644 MyKext.kext</strong><br/># <strong>kextload -v MyKext.kext</strong><br/>kextload: extension MyKext.kext appears to be valid<br/>kextload: loading extension MyKext.kext<br/>kextload: sending 1 personality to the kernel<br/>kextload: MyKext.kext loaded successfully<br/># <strong>tail -1 /var/log/system.log</strong><br/>Dec 15 20:15:47 jgm-mac kernel[0]: Hello, World!</pre>
<p><br/><br/>We can see that our <code>MyKextStart()</code> was called. Now let&#8217;s unload it and see what happens.<br/><br/></p>
<pre># <strong>kextunload -v MyKext.kext</strong><br/>kextunload: unload kext MyKext.kext succeeded</pre>
<p><br/><br/>Wahoo! It looks like we made a kernel extension with our own 10 fingers, and it worked! :-) <br/><br/>That was fun. Check out Amit Singh&#8217;s <a href="http://www.amazon.com/Mac-OS-Internals-Systems-Approach/dp/0321278542/sr=8-1/qid=1166243235/ref=pd_bbs_sr_1/104-7596969-4623161?ie=UTF8&amp;s=books">Mac OS X Internals</a> book for more cool bits about what that required &#8220;bookkeeping&#8221; stuff was in our source file, and why it&#8217;s required.</p>
